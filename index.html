<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="description"
    content="Deformable Neural Radiance Fields creates free-viewpoint portraits (nerfies) from casually captured videos.">
  <meta name="keywords" content="Nerfies, D-NeRF, NeRF">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SN3V1V2CRF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-SN3V1V2CRF');
  </script>
  <title>Iterative Object Count Optimization for Text-to-image Diffusion Models</title>


  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet">

  <link rel="stylesheet" href="./static/css/bulma.min.css">
  <link rel="stylesheet" href="./static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="./static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="./static/css/fontawesome.all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="./static/css/index.css">
  <link rel="icon" href="./static/images/favicon.svg">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="./static/js/fontawesome.all.min.js"></script>
  <script src="./static/js/bulma-carousel.min.js"></script>
  <script src="./static/js/bulma-slider.min.js"></script>
  <script src="./static/js/index.js"></script>
</head>

<body>
  <section class="hero">
    <div class="hero-body">
      <div class="container is-max-desktop">
        <div class="columns is-centered">
          <div class="column has-text-centered">
            <h1 class="title is-1 publication-title">Iterative Object Count Optimization for Text-to-image Diffusion Models</h1>
            <div class="is-size-5 publication-authors">
              <span class="author-block">
                <a href="https://github.com/ozzafar">Oz Zafar</a><sup>1</sup>,
              </span>
              <span class="author-block">
                <a href="http://www.cs.tau.ac.il/~wolf/">Lior Wolf</a><sup>1</sup>
              </span>
              <span class="author-block">
                <a href="https://idansc.github.io/">Idan Schwartz</a><sup>2</sup>,
              </span>
            </div>

            <div class="is-size-5 publication-authors">
              <span class="author-block"><sup>1</sup>Tel-Aviv University,</span>
              <span class="author-block"><sup>2</sup>Bar-Ilan University,</span>
            </div>

            <div class="column has-text-centered">
              <div class="publication-links">
                <!-- PDF Link. -->
                <span class="link-block">
                  <a href="TODO"
                    class="external-link button is-normal is-rounded is-dark">
                    <span class="icon">
                      <i class="fas fa-file-pdf"></i>
                    </span>
                    <span>Paper</span>
                  </a>
                </span>
                <span class="link-block">
                  <a href="TODO" class="external-link button is-normal is-rounded is-dark">
                    <span class="icon">
                      <i class="ai ai-arxiv"></i>
                    </span>
                    <span>arXiv</span>
                  </a>
                </span>
                <!-- Code Link. -->
                <span class="link-block">
                  <a href="https://github.com/ozzafar/discriminative_class_tokens_for_counting"
                    class="external-link button is-normal is-rounded is-dark">
                    <span class="icon">
                      <i class="fab fa-github"></i>
                    </span>
                    <span>Code</span>
                  </a>
                </span>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="hero teaser">
    <div class="container is-max-desktop">
      <img src="./static/images/teas.png" alt="Teaser" class="teaser-image">
      <h2 class="subtitle has-text-centered">
        We propose a plug-and-play optimization of object counting accuracy of a text-to-image model based on detection models.
      </h2>
    </div>
    </div>
  </section>



  <section class="section">
    <div class="container is-max-desktop">
      <!-- Abstract. -->
      <div class="columns is-centered has-text-centered">
        <div class="column is-four-fifths">
          <h2 class="title is-3">Abstract</h2>
          <div class="content has-text-justified">

            <p>We address a persistent challenge in text-to-image models: accurately generating a specified number of objects.
              Current models, which learn from image-text pairs, inherently struggle with counting, as training data cannot depict every possible number of objects for any given object.
              To solve this, we propose optimizing the generated image based on a counting loss derived from a counting model that aggregates an object’s potential.
              Employing an out-of-the-box counting model is challenging for two reasons: first, the model requires a scaling hyperparameter for the potential aggregation that varies depending on the viewpoint of the objects, and second, classifier guidance techniques require modified models that operate on noisy intermediate diffusion steps.
              To address these challenges, we propose an iterated online training mode that improves the accuracy of inferred images while altering the text conditioning embedding and dynamically adjusting hyperparameters.
              Our method offers three key advantages: (i) it can be based on any detection models; (ii) it is a zero-shot plug-and-play solution facilitating rapid changes to the counting techniques and image generation methods; and (iii) the optimized counting token can be reused to generate accurate images without further optimization.
              We evaluate the generation of various objects and show significant improvements in accuracy.
            </p>
          </div>
        </div>
      </div>
      <!--/ Abstract. -->
    </div>
  </section>


  <section class="section">
    <div class="container is-max-desktop">
      <div class="columns is-centered">
        <div class="column is-full-width">
          <h2 class="title is-2">Iterative Optimization</h2>
          <div class="columns is-vcentered interpolation-panel">
            <div class="column is-3 has-text-centered">
              <img src="./static/gifs/oranges.gif" class="interpolation-image"
                alt="Interpolate start reference image." />
              <p>5 oranges</p>
            </div>
            <div class="column is-3 has-text-centered">
              <img src="./static/gifs/cupcakes.gif" class="interpolation-image"
                alt="Interpolate start reference image." />
              <p>5 cupcakes</p>
            </div>
            <div class="column is-3 has-text-centered">
              <img src="./static/gifs/cars.gif" class="interpolation-image"
                alt="Interpolate start reference image." />
              <p>5 cars</p>
            </div>
            <div class="column is-3 has-text-centered">
              <img src="./static/gifs/sheep.gif" class="interpolation-image"
                alt="Interpolate start reference image." />
              <p>5 sheep</p>
            </div>

          </div>
          <br />


          <h2 class="title is-2">Method</h2>
          <div class="content has-text-justified">
            <p> Our method iteratively generates images and calculates a counting loss based on object potentials.
              To align the counting with non-derivable detection-based counting, we scale the potentials at each step based on a detection model (e.g., YOLO).
              We also consider a CLIP matching penalty term to maintain the semantics of the image while changing the object count.
              The loss at each step is used to update an added counting token, which is used to control the generation.
              The counting token can be reused after convergence to generate additional images with better accuracy without the need for further optimization.
            </p>
          </div>
          <div class="content has-text-centered">
            <img width="600px" src="static/images/count_method.png">
          </div>

          <h2 class="title is-2">Optimization Process</h2>
          <div class="content has-text-justified">
            <p>
              We employ a differentiable object potential model that approximates the number of objects.
              Below, we show an illustration of the optimization process at different time steps for the prompts “A photo of 5 cupcakes” and “A photo of 4 cottons”, alongside their object potential maps.            </p>
          </div>
          <div class="content has-text-centered">
            <img src="static/images/optimization_process.png">
          </div>

          <h2 class="title is-2">Detection-based Counting Scaling</h2>
          <div class="content has-text-justified">
            <p>
              A <b>scaling hyperparameter</b> is required to aggregate and normalize the potential map to a single count.
              Finding a general scaling factor for any object is challenging due to varying object sizes and different viewpoints, which lead to deformed potential maps.
              To address this, we control the generation process by scaling a hyperparameter using a detection-based counting score. This also allows us to influence the optimization according to the detection model.
            </p>
          </div>
          <div class="content has-text-centered">
            <img width="500px" src="static/images/static_vs_dynamic.png">
          </div>

          <h2 class="title is-2">Token Reuse</h2>
          <div class="content has-text-justified">
            <p>
            The count token  can be re-used. For instance, our method trained a token for the prompt “A photo of 10 oranges,” which was later employed for “A photo of 10 strawberries” or similarly for pigeons and crows.
            This potentially reduces the need for repeated inference time optimization for new counting tokens for the same quantities.
            </p>
          </div>
          <div class="content has-text-centered">
            <img src="static/images/class_transfer.png">
          </div>
            <p>
            Further, our counting token can be reused with different prompts. For instance, our token accurately counts the number of oranges even when we ask it to be with a dog.
            Moreover, we show examples of using trained tokens with different backgrounds, such as three cups in the sea, and demonstrate the ability to reuse the counting token in different styles, such as painting. <br> <br>
            </p>
          <div class="content has-text-centered">
            <img src="static/images/context.png">
          </div>

        </div>
      </div>


    </div>
  </section>


  <section class="section" id="BibTeX">
    <div class="container is-max-desktop content">
      <h2 class="title">BibTeX</h2>
      <pre><code> TODO </code></pre>
    </div>
  </section>


  <footer class="footer">
    <div class="container">
      <div class="content has-text-centered">
        <a class="icon-link" href="https://arxiv.org/pdf/2303.17155.pdf">
          <i class="fas fa-file-pdf"></i>
        </a>
        <a class="icon-link" href="https://github.com/idansc/discriminative_class_tokens" class="external-link"
          disabled>
          <i class="fab fa-github"></i>
        </a>
      </div>
      <div class="columns is-centered">
        <div class="column is-8">
          <div class="content">
            <p>
              This website is licensed under a <a rel="license"
                href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
                Commons Attribution-ShareAlike 4.0 International License</a>.
            </p>
            <p>
              This means you are free to borrow the <a href="https://github.com/vesteinn/disco">source
                code</a> of this website, we just ask that you link back to this page in the footer.
              The code is based on <a
                href="https://github.com/nerfies/nerfies.github.io">https://github.com/nerfies/nerfies.github.io</a>.
              Please remember to remove the analytics code included in the header of the website which
              you do not want on your website.
            </p>
          </div>
        </div>
      </div>
    </div>
  </footer>

</body>

</html>
